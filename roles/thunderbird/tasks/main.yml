---
# Thunderbird role - Install and configure Thunderbird email client

- name: Thunderbird | Install Thunderbird
  ansible.builtin.apt:
    name: thunderbird
    state: present
  become: true
  when: thunderbird_install_method == "apt"

- name: Thunderbird | Install Thunderbird via Snap
  community.general.snap:
    name: thunderbird
    state: present
  become: true
  when: thunderbird_install_method == "snap"

- name: Thunderbird | Create Thunderbird profile directory
  ansible.builtin.file:
    path: "{{ thunderbird_user_home }}/.thunderbird"
    state: directory
    mode: "0755"
    owner: "{{ thunderbird_username }}"
    group: "{{ thunderbird_username }}"
  become: true

# Profile copying from remote host
- name: Thunderbird | Copy profile from remote host
  ansible.builtin.include_tasks: copy_profile.yml
  when: thunderbird_copy_profile | bool

- name: Thunderbird | Check if default profile exists
  ansible.builtin.find:
    paths: "{{ thunderbird_user_home }}/.thunderbird"
    patterns: "*.default*"
    file_type: directory
  register: thunderbird_profiles
  become: true

- name: Thunderbird | Create user.js for preferences
  ansible.builtin.copy:
    content: |
      // Thunderbird user preferences - Managed by Ansible
      {% for pref in thunderbird_preferences %}
      user_pref("{{ pref.name }}", {{ pref.value | to_json }});
      {% endfor %}
    dest: "{{ thunderbird_user_home }}/.thunderbird/{{ item.path | basename }}/user.js"
    mode: "0644"
    owner: "{{ thunderbird_username }}"
    group: "{{ thunderbird_username }}"
  become: true
  loop: "{{ thunderbird_profiles.files }}"
  when: thunderbird_profiles.files | length > 0 and thunderbird_preferences | length > 0

# Note: Lightning calendar is now built into Thunderbird 102+
# The xul-ext-lightning package is no longer needed or available
- name: Thunderbird | Lightning calendar note
  ansible.builtin.debug:
    msg: "Lightning calendar is built into Thunderbird 102+. No separate extension needed."
  when: thunderbird_install_lightning | bool
