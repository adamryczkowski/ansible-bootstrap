---
# User Setup Role - User creation and SSH configuration
#
# Purpose:
#   Creates user accounts, configures SSH access, sets up sudo permissions,
#   and creates common directories. Supports deploying SSH keys from a central
#   repository for authorized operators.
#
# Key Variables:
#   - user_setup_username: Username to create (default: target_user or ansible_user)
#   - user_setup_shell: User's shell (default: /bin/bash)
#   - user_setup_groups: Groups to add user to (default: [sudo])
#   - user_setup_generate_ssh_key: Generate SSH keypair (default: true)
#   - user_setup_authorized_keys: List of SSH public keys to authorize
#   - user_setup_authorized_operators: List of operator names (keys from files/ssh_keys/)
#   - user_setup_sudo_nopasswd: Enable passwordless sudo (default: true)
#   - user_setup_directories: Directories to create in home (default: [tmp, projects])
#
# Dependencies:
#   - community.crypto collection (for openssh_keypair module)
#   - ansible.posix collection (for authorized_key module)
#
# Example Usage:
#   - role: user_setup
#     vars:
#       user_setup_username: developer
#       user_setup_authorized_operators:
#         - adam

- name: User Setup | Create user
  ansible.builtin.user:
    name: "{{ user_setup_username }}"
    shell: "{{ user_setup_shell }}"
    groups: "{{ user_setup_groups }}"
    append: true
    create_home: true
    state: present
  become: true

- name: User Setup | Create .ssh directory
  ansible.builtin.file:
    path: "/home/{{ user_setup_username }}/.ssh"
    state: directory
    mode: "0700"
    owner: "{{ user_setup_username }}"
    group: "{{ user_setup_username }}"
  become: true

- name: User Setup | Generate SSH key if not exists
  community.crypto.openssh_keypair:
    path: "/home/{{ user_setup_username }}/.ssh/{{ user_setup_ssh_key_name }}"
    type: "{{ user_setup_ssh_key_type }}"
    owner: "{{ user_setup_username }}"
    group: "{{ user_setup_username }}"
    mode: "0600"
  become: true
  when: user_setup_generate_ssh_key | bool

- name: User Setup | Add authorized keys (direct)
  ansible.posix.authorized_key:
    user: "{{ user_setup_username }}"
    key: "{{ item }}"
    state: present
  loop: "{{ user_setup_authorized_keys }}"
  become: true
  when: user_setup_authorized_keys | length > 0

- name: User Setup | Deploy operator keys from central repository
  ansible.posix.authorized_key:
    user: "{{ user_setup_username }}"
    key: "{{ lookup('file', 'ssh_keys/' + item + '.pub') }}"
    state: present
  loop: "{{ user_setup_authorized_operators }}"
  become: true
  when:
    - user_setup_deploy_operator_keys | bool
    - user_setup_authorized_operators | length > 0

- name: User Setup | Create common directories
  ansible.builtin.file:
    path: "/home/{{ user_setup_username }}/{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ user_setup_username }}"
    group: "{{ user_setup_username }}"
  loop: "{{ user_setup_directories }}"
  become: true
  when: user_setup_directories | length > 0

- name: User Setup | Configure sudo access
  ansible.builtin.lineinfile:
    path: "/etc/sudoers.d/{{ user_setup_username }}"
    line: "{{ user_setup_username }} ALL=(ALL) NOPASSWD: ALL"
    create: true
    mode: "0440"
    validate: "visudo -cf %s"
  become: true
  when: user_setup_sudo_nopasswd | bool

- name: User Setup | Clone update-all repository
  ansible.builtin.git:
    repo: "{{ user_setup_update_all_repo }}"
    dest: "/home/{{ user_setup_username }}/tmp/update-all"
    depth: 1
    update: true
  become: true
  become_user: "{{ user_setup_username }}"
  when: user_setup_clone_update_all | bool
