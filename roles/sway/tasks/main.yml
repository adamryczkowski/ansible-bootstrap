---
# Sway role - Install and configure Sway window manager (Wayland compositor)
#
# This role supports both Debian/Ubuntu and Arch Linux:
# - On Debian/Ubuntu: Uses Nix for Sway 1.11+ (Ubuntu 24.04 only has 1.9)
# - On Arch Linux: Uses native pacman packages (latest versions available)
#
# The setup includes:
# - Sway compositor with supporting tools (waybar, wofi, mako, etc.)
# - Configuration from https://gitlab.com/adamwam/i3-config.git

- name: Sway | Get user UID for systemd user services
  ansible.builtin.getent:
    database: passwd
    key: "{{ sway_username }}"
  register: sway_user_info

- name: Sway | Set user UID fact
  ansible.builtin.set_fact:
    sway_user_uid: "{{ sway_user_info.ansible_facts.getent_passwd[sway_username][1] }}"

# Package installation - distro-specific
- name: Sway | Include apt packages installation (Debian/Ubuntu)
  ansible.builtin.include_tasks: apt_packages.yml
  when: ansible_os_family == "Debian"

- name: Sway | Include pacman packages installation (Arch Linux)
  ansible.builtin.include_tasks: pacman_packages.yml
  when: ansible_os_family == "Archlinux"

- name: Sway | Include fonts installation
  ansible.builtin.include_tasks: fonts.yml

- name: Sway | Include XDG Desktop Portal configuration
  ansible.builtin.include_tasks: portal.yml

# Nix installation - only needed on Debian/Ubuntu for latest Sway
- name: Sway | Include Nix installation
  ansible.builtin.include_tasks: nix.yml
  when:
    - sway_install_method == 'nix'
    - ansible_os_family == "Debian"

# Foot terminal from source - only needed on Debian/Ubuntu
# On Arch, foot is already installed via pacman with latest version
- name: Sway | Include Foot terminal installation (from source)
  ansible.builtin.include_tasks: foot.yml
  when:
    - sway_install_foot_from_source | bool
    - ansible_os_family == "Debian"

- name: Sway | Include configuration setup
  ansible.builtin.include_tasks: config.yml

- name: Sway | Include hardcoded path fixes for i3-config repository
  ansible.builtin.include_tasks: fix_hardcoded_paths.yml
  when: sway_fix_hardcoded_paths | bool

- name: Sway | Include swayidle monitor wake fix
  ansible.builtin.include_tasks: fix_swayidle.yml
  when: sway_fix_swayidle_monitor_wake | bool

- name: Sway | Include GTK theme configuration for automatic dark/light mode
  ansible.builtin.include_tasks: gtk_theme.yml
  when: sway_configure_gtk_theme | bool

- name: Sway | Include XKB keyboard configuration
  ansible.builtin.include_tasks: xkb.yml
  when: sway_deploy_custom_xkb_keymap | bool

- name: Sway | Include Fusuma installation
  ansible.builtin.include_tasks: fusuma.yml
  when: sway_install_fusuma | bool

- name: Sway | Include nethogs sudoers configuration
  ansible.builtin.include_tasks: nethogs.yml
  when: sway_configure_nethogs_sudoers | bool

- name: Sway | Include iotop configuration for disk traffic monitoring
  ansible.builtin.include_tasks: iotop.yml
  when: sway_configure_iotop | bool

- name: Sway | Include usbmon configuration for USB traffic monitoring
  ansible.builtin.include_tasks: usbmon.yml
  when: sway_configure_usbmon | bool

- name: Sway | Include lock-before-sleep service configuration
  ansible.builtin.include_tasks: lock_before_sleep.yml
  when: sway_configure_lock_before_sleep | bool

- name: Sway | Include session setup
  ansible.builtin.include_tasks: session.yml
  when: sway_create_desktop_entry | bool

- name: Sway | Include greetd display manager configuration (Arch Linux)
  ansible.builtin.include_tasks: greetd.yml
  when:
    - sway_install_greetd | bool
    - ansible_os_family == "Archlinux"

- name: Sway | Include Slack Wayland compatibility
  ansible.builtin.include_tasks: slack.yml
  when: sway_configure_slack_wayland | bool

- name: Sway | Include bright CLI tool installation
  ansible.builtin.include_tasks: bright.yml
  when: sway_install_bright | bool

- name: Sway | Include fingerprint authentication configuration
  ansible.builtin.include_tasks: fingerprint.yml
  when: sway_enable_fingerprint_auth | bool
