---
# Sway role - Create desktop session entry for display manager

# GDM configuration - Debian/Ubuntu uses /etc/gdm3, Arch uses /etc/gdm
- name: Sway | Enable Wayland in GDM configuration (Debian/Ubuntu)
  ansible.builtin.lineinfile:
    path: /etc/gdm3/custom.conf
    regexp: '^#?WaylandEnable='
    line: 'WaylandEnable=true'
    insertafter: '^\[daemon\]'
    state: present
  become: true
  when:
    - sway_enable_wayland_in_gdm | default(true) | bool
    - ansible_os_family == "Debian"
  failed_when: false  # GDM may not be installed

- name: Sway | Enable Wayland in GDM configuration (Arch Linux)
  ansible.builtin.lineinfile:
    path: /etc/gdm/custom.conf
    regexp: '^#?WaylandEnable='
    line: 'WaylandEnable=true'
    insertafter: '^\[daemon\]'
    state: present
  become: true
  when:
    - sway_enable_wayland_in_gdm | default(true) | bool
    - ansible_os_family == "Archlinux"
  failed_when: false  # GDM may not be installed

- name: Sway | Ensure wayland-sessions directory exists
  ansible.builtin.file:
    path: /usr/share/wayland-sessions
    state: directory
    mode: "0755"
    owner: root
    group: root
  become: true

# Desktop entry name depends on install method
- name: Sway | Create Sway desktop entry for display manager (Nix)
  ansible.builtin.template:
    src: sway.desktop.j2
    dest: /usr/share/wayland-sessions/sway-nix.desktop
    mode: "0644"
    owner: root
    group: root
  become: true
  when: sway_install_method == 'nix'

- name: Sway | Create Sway desktop entry for display manager (Native)
  ansible.builtin.template:
    src: sway.desktop.j2
    dest: /usr/share/wayland-sessions/sway.desktop
    mode: "0644"
    owner: root
    group: root
  become: true
  when: sway_install_method == 'native'

- name: Sway | Create environment file for Sway session
  ansible.builtin.template:
    src: sway-environment.j2
    dest: "/home/{{ sway_username }}/.config/sway-environment"
    mode: "0644"
    owner: "{{ sway_username }}"
    group: "{{ sway_username }}"
  become: true

- name: Sway | Ensure systemd user directory exists
  ansible.builtin.file:
    path: "/home/{{ sway_username }}/.config/systemd/user"
    state: directory
    mode: "0755"
    owner: "{{ sway_username }}"
    group: "{{ sway_username }}"
  become: true

- name: Sway | Create systemd user service for environment import
  ansible.builtin.template:
    src: sway-session.target.j2
    dest: "/home/{{ sway_username }}/.config/systemd/user/sway-session.target"
    mode: "0644"
    owner: "{{ sway_username }}"
    group: "{{ sway_username }}"
  become: true
