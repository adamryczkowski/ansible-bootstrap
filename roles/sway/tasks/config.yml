---
# Sway role - Clone and configure i3-config repository

- name: Sway | Ensure .config directory exists
  ansible.builtin.file:
    path: "/home/{{ sway_username }}/.config"
    state: directory
    mode: "0755"
    owner: "{{ sway_username }}"
    group: "{{ sway_username }}"
  become: true

- name: Sway | Check if i3-config repository exists
  ansible.builtin.stat:
    path: "{{ sway_config_dest }}/.git"
  register: sway_i3_config_repo

- name: Sway | Clone i3-config repository
  ansible.builtin.git:
    repo: "{{ sway_config_repo }}"
    dest: "{{ sway_config_dest }}"
    version: "{{ sway_config_branch }}"
    update: true
    recursive: false
  become: true
  become_user: "{{ sway_username }}"
  when: not sway_i3_config_repo.stat.exists

# The git module doesn't support 'fetch --all' which is needed when switching branches
# that weren't previously fetched from the remote
- name: Sway | Fetch all remote branches  # noqa: command-instead-of-module
  ansible.builtin.command:
    cmd: git fetch --all
    chdir: "{{ sway_config_dest }}"
  become: true
  become_user: "{{ sway_username }}"
  changed_when: false
  when: sway_i3_config_repo.stat.exists

- name: Sway | Update i3-config repository
  ansible.builtin.git:
    repo: "{{ sway_config_repo }}"
    dest: "{{ sway_config_dest }}"
    version: "{{ sway_config_branch }}"
    update: true
    recursive: false
    force: true  # Allow overwriting local modifications (XKB keymap is managed by Ansible)
  become: true
  become_user: "{{ sway_username }}"
  when: sway_i3_config_repo.stat.exists

- name: Sway | Create configuration symlinks
  when: sway_create_config_symlinks | bool
  block:
    - name: Sway | Check existing config paths
      ansible.builtin.stat:
        path: "/home/{{ sway_username }}/.config/{{ item.dest }}"
      register: sway_config_paths
      loop: "{{ sway_config_symlinks }}"

    - name: Sway | Remove existing config directories if they are not symlinks
      ansible.builtin.file:
        path: "/home/{{ sway_username }}/.config/{{ item.item.dest }}"
        state: absent
      become: true
      loop: "{{ sway_config_paths.results }}"
      when: item.stat.exists and not item.stat.islnk
      loop_control:
        label: "{{ item.item.dest }}"

    - name: Sway | Create symlinks for Sway configuration
      ansible.builtin.file:
        src: "{{ sway_config_dest }}/{{ item.src }}"
        dest: "/home/{{ sway_username }}/.config/{{ item.dest }}"
        state: link
        owner: "{{ sway_username }}"
        group: "{{ sway_username }}"
        force: true
      become: true
      loop: "{{ sway_config_symlinks }}"

- name: Sway | Check if xkb directory exists in i3-config
  ansible.builtin.stat:
    path: "{{ sway_config_dest }}/xkb"
  register: sway_xkb_source

- name: Sway | Check existing XKB config path
  ansible.builtin.stat:
    path: "/home/{{ sway_username }}/.config/xkb"
  register: sway_xkb_dest
  when: sway_xkb_source.stat.exists

- name: Sway | Remove existing XKB directory if not a symlink
  ansible.builtin.file:
    path: "/home/{{ sway_username }}/.config/xkb"
    state: absent
  become: true
  when:
    - sway_xkb_source.stat.exists
    - sway_xkb_dest.stat.exists
    - not sway_xkb_dest.stat.islnk

- name: Sway | Create XKB symlink if xkb directory exists in i3-config
  ansible.builtin.file:
    src: "{{ sway_config_dest }}/xkb"
    dest: "/home/{{ sway_username }}/.config/xkb"
    state: link
    owner: "{{ sway_username }}"
    group: "{{ sway_username }}"
    force: true
  become: true
  when: sway_xkb_source.stat.exists

- name: Sway | Ensure XKB config directory exists (when no symlink source)
  ansible.builtin.file:
    path: "/home/{{ sway_username }}/.config/xkb"
    state: directory
    mode: "0755"
    owner: "{{ sway_username }}"
    group: "{{ sway_username }}"
  become: true
  when: not sway_xkb_source.stat.exists

- name: Sway | Ensure kanshi config directory exists
  ansible.builtin.file:
    path: "/home/{{ sway_username }}/.config/kanshi"
    state: directory
    mode: "0755"
    owner: "{{ sway_username }}"
    group: "{{ sway_username }}"
  become: true
