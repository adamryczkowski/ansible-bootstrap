# wayVNC Playbook Implementation Plan

## Overview

This plan describes the implementation of an Ansible playbook to install and configure wayVNC server on Ubuntu 24.04 LTS systems running Sway.

## Research Sources Used

1. **GitHub any1/wayvnc** (<https://github.com/any1/wayvnc>) - Official repository, latest v0.9.1
2. **Ubuntu Packages** (<https://packages.ubuntu.com/noble/wayvnc>) - Ubuntu 24.04 has v0.7.2 in universe repo
3. **GitHub Gist itsfolf** (<https://gist.github.com/itsfolf/1029f674eca3783f2d123521ff6a4ceb>) - Detailed setup guide
4. **GitHub any1/wayvnc FAQ.md** (<https://github.com/any1/wayvnc/blob/master/FAQ.md>) - Official FAQ

## Configuration Requirements

Based on operator input:

- **Server only**: No VNC client installation needed
- **Bind address**: Machine's IP on 192.168.42.0/24 network (dynamically detected)
- **Authentication**: TLS with username/password enabled
- **SSH tunneling**: Also supported for localhost access
- **Autostart**: Systemd user service
- **No UFW rules**: Firewall configuration not included

## Technical Constraints

- wayVNC can only bind to ONE address at a time
- wayVNC requires a running Wayland session to attach to
- Login screen access requires separate solution (out of scope for now)
- Ubuntu 24.04 provides wayVNC v0.7.2 via apt (sufficient for this use case)

## Role Structure

```text
roles/wayvnc/
├── defaults/
│   └── main.yml          # Default variables
├── handlers/
│   └── main.yml          # Service restart handlers
├── meta/
│   └── main.yml          # Role metadata
├── tasks/
│   ├── main.yml          # Main task orchestration
│   ├── install.yml       # Package installation
│   ├── config.yml        # Configuration file setup
│   ├── certificates.yml  # TLS certificate generation
│   ├── systemd.yml       # Systemd user service setup
│   └── verify.yml        # Verification tasks
└── templates/
    ├── config.j2         # wayVNC config file template
    └── wayvnc.service.j2 # Systemd user service template
```

## Implementation Details

### 1. defaults/main.yml

```yaml
# Username for wayVNC configuration
wayvnc_username: "{{ target_user | default(ansible_user) | default('adam') }}"

# VNC port (default 5900)
wayvnc_port: 5900

# Bind address - auto-detect from 192.168.42.0/24 network or use specified
wayvnc_bind_address: "auto"  # Will be detected from ansible_facts
wayvnc_preferred_network: "192.168.42"

# Authentication settings
wayvnc_enable_auth: true
wayvnc_vnc_username: "{{ wayvnc_username }}"
# Password should be set via inventory or vault
# wayvnc_vnc_password: ""

# TLS certificate settings
wayvnc_tls_enabled: true
wayvnc_cert_days: 3650  # 10 years
wayvnc_cert_key_size: 4096

# Systemd service settings
wayvnc_enable_service: true
wayvnc_start_service: true

# Wayland display (usually wayland-1 for active session)
wayvnc_wayland_display: "wayland-1"
```

### 2. tasks/main.yml

Orchestrates the installation flow:

1. Validate Ubuntu version
2. Include install.yml - Install wayVNC package
3. Include certificates.yml - Generate TLS certificates
4. Include config.yml - Deploy configuration
5. Include systemd.yml - Setup systemd user service
6. Include verify.yml - Verify installation

### 3. tasks/install.yml

- Install wayVNC from Ubuntu universe repository
- Install wayvncctl (control utility, comes with wayvnc package)

### 4. tasks/certificates.yml

- Create ~/.config/wayvnc directory
- Generate self-signed TLS certificate using openssl
- Generate RSA key for RSA-AES authentication
- Set proper permissions (600) on key files

### 5. tasks/config.yml

- Detect bind address from ansible_facts (192.168.42.x interface)
- Deploy config file from template
- Set proper permissions

### 6. tasks/systemd.yml

- Create systemd user service directory
- Deploy wayvnc.service template
- Enable lingering for user (allows user services without login)
- Enable and start the service

### 7. tasks/verify.yml

- Check wayVNC binary exists
- Verify config file exists
- Check certificate files exist
- Verify systemd service status
- Test port binding (if service is running)

### 8. templates/config.j2

```ini
# wayVNC configuration
# Generated by Ansible - do not edit manually

# Network settings
address={{ wayvnc_bind_address_resolved }}
port={{ wayvnc_port }}

# Authentication
enable_auth={{ 'true' if wayvnc_enable_auth else 'false' }}
{% if wayvnc_enable_auth %}
username={{ wayvnc_vnc_username }}
password={{ wayvnc_vnc_password }}
{% endif %}

# TLS settings
{% if wayvnc_tls_enabled %}
use_relative_paths=true
private_key_file=key.pem
certificate_file=cert.pem
rsa_private_key_file=rsa_key.pem
{% endif %}
```

### 9. templates/wayvnc.service.j2

```ini
[Unit]
Description=wayVNC VNC server for Wayland
After=graphical-session.target
BindsTo=sway-session.target

[Service]
Type=simple
Environment=WAYLAND_DISPLAY={{ wayvnc_wayland_display }}
ExecStart=/usr/bin/wayvnc
Restart=on-failure
RestartSec=5

[Install]
WantedBy=sway-session.target
```

### 10. playbooks/wayvnc.yml

```yaml
---
# wayVNC playbook - Install and configure wayVNC server
#
# Usage:
#   ansible-playbook -i inventory/production/hosts.yml playbooks/wayvnc.yml --limit sk-pf3d0a9t
#
# Requirements:
#   - Ubuntu 24.04 LTS
#   - Sway window manager installed and configured
#   - wayvnc_vnc_password must be set (via inventory, extra vars, or vault)

- name: Install and configure wayVNC server
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Verify Ubuntu 24.04
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version is version('24.04', '>=')
        fail_msg: "This playbook requires Ubuntu 24.04 or later"

    - name: Verify wayvnc_vnc_password is set
      ansible.builtin.assert:
        that:
          - wayvnc_vnc_password is defined
          - wayvnc_vnc_password | length > 0
        fail_msg: "wayvnc_vnc_password must be set for authentication"

  roles:
    - role: wayvnc
      tags: [wayvnc]

  post_tasks:
    - name: Display connection information
      ansible.builtin.debug:
        msg: |
          ============================================
          wayVNC Installation Complete!
          ============================================

          Server: {{ wayvnc_bind_address_resolved | default(ansible_host) }}:{{ wayvnc_port }}
          Username: {{ wayvnc_vnc_username }}

          To connect:
            1. Use any VNC client (TigerVNC, Remmina, RealVNC)
            2. Connect to: {{ wayvnc_bind_address_resolved | default(ansible_host) }}:{{ wayvnc_port }}
            3. Accept the self-signed certificate
            4. Enter username and password

          For SSH tunneling:
            ssh -L 5900:localhost:5900 {{ ansible_user }}@{{ ansible_host }}
            Then connect to: localhost:5900

          ============================================
```

## Testing Plan

1. **Pre-flight checks on target host**:
    - Verify Sway is installed and can be started
    - Check network interface for 192.168.42.x address
    - Verify universe repository is enabled

2. **Run playbook**:

    ```bash
    ansible-playbook -i inventory/production/hosts.yml playbooks/wayvnc.yml \
      --limit sk-pf3d0a9t \
      -e wayvnc_vnc_password=<secure_password>
    ```

3. **Verification steps**:
    - Check wayVNC package is installed
    - Verify config file at ~/.config/wayvnc/config
    - Check TLS certificates exist
    - Verify systemd user service is enabled
    - Test VNC connection from another machine

## Security Considerations

1. **Password storage**: Use Ansible Vault for storing VNC password in inventory
2. **TLS certificates**: Self-signed, valid for 10 years
3. **Network exposure**: Only binds to 192.168.42.x network, not public interfaces
4. **SSH tunneling**: Recommended for additional security layer

## Dependencies

- Ubuntu 24.04 LTS
- Sway window manager (from existing sway role)
- Universe repository enabled (for wayVNC package)

## Files to Create

1. `roles/wayvnc/defaults/main.yml`
2. `roles/wayvnc/handlers/main.yml`
3. `roles/wayvnc/meta/main.yml`
4. `roles/wayvnc/tasks/main.yml`
5. `roles/wayvnc/tasks/install.yml`
6. `roles/wayvnc/tasks/config.yml`
7. `roles/wayvnc/tasks/certificates.yml`
8. `roles/wayvnc/tasks/systemd.yml`
9. `roles/wayvnc/tasks/verify.yml`
10. `roles/wayvnc/templates/config.j2`
11. `roles/wayvnc/templates/wayvnc.service.j2`
12. `playbooks/wayvnc.yml`

## Commit Message (Draft)

```text
feat(wayvnc): Add wayVNC server role and playbook

- Install wayVNC from Ubuntu 24.04 universe repository
- Configure TLS encryption with self-signed certificates
- Enable username/password authentication
- Setup systemd user service for autostart
- Auto-detect bind address from 192.168.42.0/24 network
- Include verification tasks

Tested on: Ubuntu 24.04 LTS with Sway
```
