---
# Molecule converge playbook for LXD E2E test
# Mimics make-lxd-node.sh with prepare-ubuntu.sh --cli-improved
#
# This applies the full configuration including:
# - Base system configuration (common role)
# - Package management (packages role)
# - User setup (user_setup role)
# - Shell configuration (bashrc role)
# - Rust toolchain (rust role)
# - CLI tools (cli_tools role) - with 'full' profile (equivalent to --cli-improved)

- name: Converge - Full LXD node configuration
  hosts: all
  become: true
  gather_facts: true

  vars:
    target_user: testuser

    # Use 'full' profile for E2E testing (--cli-improved equivalent)
    cli_tools_profile: full

    # Packages role configuration
    packages_apt_packages:
      - build-essential
      - git
      - vim
      - htop
      - tmux
      - tree
      - jq
      - unzip
      - zip

    # User setup configuration
    user_setup_username: "{{ target_user }}"
    user_setup_create_bashrc_d: true

    # Bashrc configuration
    bashrc_username: "{{ target_user }}"

    # Rust configuration
    rust_username: "{{ target_user }}"
    rust_install_binstall: true

    # CLI tools configuration
    cli_tools_username: "{{ target_user }}"

  pre_tasks:
    - name: Display test configuration
      ansible.builtin.debug:
        msg: |
          LXD E2E Test Configuration:
          - Target user: {{ target_user }}
          - CLI profile: {{ cli_tools_profile }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

  roles:
    # Base system configuration (prepare_ubuntu.sh equivalent)
    - role: common
      tags: [common, base]

    # Package management
    - role: packages
      tags: [packages, base]

    # User setup
    - role: user_setup
      vars:
        user_setup_username: "{{ target_user }}"
      tags: [user, base]

    # Shell configuration
    - role: bashrc
      vars:
        bashrc_username: "{{ target_user }}"
      tags: [bashrc, base]

    # Rust toolchain (required for full profile)
    - role: rust
      vars:
        rust_username: "{{ target_user }}"
        rust_packages: "{{ cli_tools_rust_packages | default([]) }}"
      when: cli_tools_profile == 'full'
      tags: [rust, cli]

    # CLI tools (--cli-improved equivalent with full profile)
    - role: cli_tools
      vars:
        cli_tools_username: "{{ target_user }}"
      tags: [cli_tools, cli]

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          LXD E2E Test Converge Complete!
          The following has been configured:
          - Base system (locale, timezone, sysctl)
          - APT packages
          - User: {{ target_user }}
          - Bash configuration with bashrc.d
          {% if cli_tools_profile == 'full' %}
          - Rust toolchain with cargo-binstall
          - CLI tools (bat, eza, fd, ripgrep, zoxide, atuin, etc.)
          - Improved aliases (cat=bat, ls=eza, find=fd, grep=rg, etc.)
          - liquidprompt for adaptive shell prompt
          - Nerd Fonts for terminal icons
          {% else %}
          - Basic CLI tools (htop, tmux, jq, etc.)
          - mise (polyglot runtime manager)
          - fzf (fuzzy finder)
          {% endif %}
