---
# LXD Node playbook - Configure LXD host and provision containers
# Replaces make-lxd-node.sh
#
# This playbook supports two CLI profiles for container configuration:
#   - minimal: Basic CLI tools for a functional command-line experience
#   - full: Enhanced CLI experience equivalent to --cli-improved flag
#
# Usage examples:
#   # Minimal profile (default)
#   ansible-playbook playbooks/lxd_node.yml -i inventory/lxd.yml
#
#   # Full profile (--cli-improved equivalent)
#   ansible-playbook playbooks/lxd_node.yml -i inventory/lxd.yml -e cli_tools_profile=full

- name: Configure LXD host
  hosts: lxd_hosts
  become: true
  gather_facts: true

  vars:
    target_user: "{{ ansible_user | default('adam') }}"

  roles:
    - role: lxd
      vars:
        lxd_username: "{{ target_user }}"
      tags: [lxd]

  post_tasks:
    - name: Display LXD configuration
      ansible.builtin.debug:
        msg: "LXD host configuration complete"

- name: Provision LXD containers
  hosts: lxd_hosts
  become: true
  gather_facts: true

  vars:
    lxd_containers: []
    # Example:
    # lxd_containers:
    #   - name: dev-container
    #     image: ubuntu:24.04
    #     profiles:
    #       - default
    #     config:
    #       limits.cpu: "2"
    #       limits.memory: 4GB

  tasks:
    - name: Create LXD containers
      community.general.lxd_container:
        name: "{{ item.name }}"
        state: started
        source:
          type: image
          mode: pull
          server: https://images.linuxcontainers.org
          alias: "{{ item.image }}"
        profiles: "{{ item.profiles | default(['default']) }}"
        config: "{{ item.config | default({}) }}"
        wait_for_ipv4_addresses: true
        timeout: 600
      loop: "{{ lxd_containers }}"
      when: lxd_containers | length > 0

    - name: Wait for containers to be ready
      ansible.builtin.pause:
        seconds: 10
      when: lxd_containers | length > 0

- name: Configure LXD containers
  hosts: lxd_containers
  connection: community.general.lxd
  become: true
  gather_facts: true

  vars:
    target_user: ubuntu

    # CLI profile: 'minimal' or 'full'
    # - minimal: Basic tools (htop, tmux, jq, etc.)
    # - full: All tools including Rust-based replacements (equivalent to --cli-improved)
    cli_tools_profile: minimal

  pre_tasks:
    - name: Display container configuration
      ansible.builtin.debug:
        msg: |
          LXD Container Configuration:
          - Target user: {{ target_user }}
          - CLI profile: {{ cli_tools_profile }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}

  roles:
    # Base system configuration
    - role: common
      tags: [common, base]

    # Package management
    - role: packages
      tags: [packages, base]

    # User setup
    - role: user_setup
      vars:
        user_setup_username: "{{ target_user }}"
      tags: [user, base]

    # Shell configuration
    - role: bashrc
      vars:
        bashrc_username: "{{ target_user }}"
      tags: [bashrc, base]

    # Rust toolchain (required for full profile)
    - role: rust
      vars:
        rust_username: "{{ target_user }}"
        rust_packages: "{{ cli_tools_rust_packages | default([]) }}"
      when: cli_tools_profile == 'full'
      tags: [rust, cli]

    # CLI tools (mise, fzf, and profile-specific tools)
    - role: cli_tools
      vars:
        cli_tools_username: "{{ target_user }}"
      tags: [cli_tools, cli]

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          LXD container configuration complete!
          - User: {{ target_user }}
          - CLI profile: {{ cli_tools_profile }}
