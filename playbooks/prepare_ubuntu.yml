---
# Prepare Ubuntu playbook - Base system configuration
# Replaces prepare_ubuntu.sh
#
# This playbook supports two CLI profiles:
#   - minimal: Basic CLI tools for a functional command-line experience
#   - full: Enhanced CLI experience equivalent to --cli-improved flag
#
# Usage examples:
#   # Minimal profile (default)
#   ansible-playbook playbooks/prepare_ubuntu.yml -i inventory/hosts.yml
#
#   # Full profile (--cli-improved equivalent)
#   ansible-playbook playbooks/prepare_ubuntu.yml -i inventory/hosts.yml -e cli_tools_profile=full
#
#   # With specific user
#   ansible-playbook playbooks/prepare_ubuntu.yml -i inventory/hosts.yml -e target_user=myuser -e cli_tools_profile=full

- name: Prepare Ubuntu system
  hosts: all
  become: true
  gather_facts: true

  vars:
    # Override these in inventory or command line
    target_user: "{{ ansible_user | default('adam') }}"

    # CLI profile: 'minimal' or 'full'
    # - minimal: Basic tools (htop, tmux, jq, etc.)
    # - full: All tools including Rust-based replacements (equivalent to --cli-improved)
    cli_tools_profile: minimal

  pre_tasks:
    - name: Display configuration
      ansible.builtin.debug:
        msg: |
          Prepare Ubuntu Configuration:
          - Target user: {{ target_user }}
          - CLI profile: {{ cli_tools_profile }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

  roles:
    # Base system configuration (locale, timezone, sysctl, VPN reconnect script)
    - role: common
      vars:
        common_install_reconnect_vpn: true
      tags: [common, base]

    # Package management (APT packages)
    - role: packages
      tags: [packages, base]

    # User setup (create user, SSH keys, etc.)
    - role: user_setup
      vars:
        user_setup_username: "{{ target_user }}"
      tags: [user, base]

    # Shell configuration (bashrc.d setup)
    - role: bashrc
      vars:
        bashrc_username: "{{ target_user }}"
      tags: [bashrc, base]

    # Rust toolchain (required for full profile)
    - role: rust
      vars:
        rust_username: "{{ target_user }}"
        rust_packages: "{{ cli_tools_rust_packages | default([]) }}"
      when: cli_tools_profile == 'full'
      tags: [rust, cli]

    # CLI tools (mise, fzf, and profile-specific tools)
    - role: cli_tools
      vars:
        cli_tools_username: "{{ target_user }}"
      tags: [cli_tools, cli]

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Ubuntu system preparation complete!
          - User: {{ target_user }}
          - CLI profile: {{ cli_tools_profile }}
          {% if cli_tools_profile == 'full' %}
          Full profile includes:
          - Rust toolchain with cargo-binstall
          - Modern CLI tools: bat, eza, fd, ripgrep, zoxide, atuin, etc.
          - Improved aliases: cat=bat, ls=eza, find=fd, grep=rg, etc.
          - liquidprompt for adaptive shell prompt
          - Nerd Fonts for terminal icons
          {% else %}
          Minimal profile includes:
          - Basic CLI tools: htop, tmux, jq, git, etc.
          - mise (polyglot runtime manager)
          - fzf (fuzzy finder)
          {% endif %}
