---
# Sway playbook - Install and configure Sway window manager
#
# This playbook installs Sway (Wayland compositor) and configures it with
# the i3-config repository. Supports both Debian/Ubuntu and Arch Linux.
#
# Usage:
#   ansible-playbook -i inventory/virtualbox-test/hosts.yml playbooks/sway.yml
#
# On Debian/Ubuntu:
# - Sway 1.11+ via Nix (with nixGL wrapper for OpenGL)
# - Foot terminal compiled from source
# - Supporting tools (waybar, wofi, mako, etc.) via apt
#
# On Arch Linux:
# - Sway and all tools installed natively via pacman (latest versions)
# - No Nix needed - Arch repos have the latest versions
#
# Configuration from https://gitlab.com/adamwam/i3-config.git

- name: Install and configure Sway window manager
  hosts: all
  become: true
  gather_facts: true

  vars:
    target_user: "{{ ansible_user | default('adam') }}"

  pre_tasks:
    # Debian/Ubuntu specific pre-tasks
    - name: Ensure python3-cffi is installed (required for cryptography module)
      ansible.builtin.raw: |
        dpkg -s python3-cffi >/dev/null 2>&1 || apt-get update && apt-get install -y python3-cffi
      changed_when: false
      when: ansible_os_family == "Debian"

    - name: Update apt cache with broken repository handling
      when: ansible_os_family == "Debian"
      block:
        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: true
            cache_valid_time: 3600
      rescue:
        - name: Display warning about broken repositories
          ansible.builtin.debug:
            msg: |
              WARNING: apt cache update failed, likely due to broken third-party repositories.
              Common causes include expired GPG keys, unreachable servers, or weak signatures.
              Attempting to identify and disable problematic repositories...

        - name: Identify and disable broken repositories
          ansible.builtin.shell: |
            #!/bin/bash
            set -e
            DISABLED_REPOS=""
            APT_OPTS="-o Dir::Etc::sourceparts=/dev/null -o APT::Get::List-Cleanup=0"
            ERROR_PATTERN="(NO_PUBKEY|not signed|weak algorithm|Could not connect)"

            # Check .list files in sources.list.d
            for repo_file in /etc/apt/sources.list.d/*.list; do
              [ -f "$repo_file" ] || continue
              repo_name=$(basename "$repo_file" .list)
              if apt-get update -o Dir::Etc::sourcelist="$repo_file" $APT_OPTS 2>&1 | grep -qE "$ERROR_PATTERN"; then
                mv "$repo_file" "${repo_file}.disabled"
                DISABLED_REPOS="$DISABLED_REPOS $repo_name"
              fi
            done

            # Check .sources files (DEB822 format) in sources.list.d
            for repo_file in /etc/apt/sources.list.d/*.sources; do
              [ -f "$repo_file" ] || continue
              repo_name=$(basename "$repo_file" .sources)
              if apt-get update -o Dir::Etc::sourcelist="$repo_file" $APT_OPTS 2>&1 | grep -qE "$ERROR_PATTERN"; then
                mv "$repo_file" "${repo_file}.disabled"
                DISABLED_REPOS="$DISABLED_REPOS $repo_name"
              fi
            done

            if [ -n "$DISABLED_REPOS" ]; then
              echo "Disabled broken repositories:$DISABLED_REPOS"
            else
              echo "No broken repositories found to disable"
            fi
          args:
            executable: /bin/bash
          register: disable_repos_result
          changed_when: "'Disabled broken repositories' in disable_repos_result.stdout"

        - name: Show disabled repositories
          ansible.builtin.debug:
            msg: "{{ disable_repos_result.stdout }}"

        - name: Retry apt cache update after disabling broken repos
          ansible.builtin.apt:
            update_cache: true
            cache_valid_time: 0

    - name: Install essential packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - git
          - curl
          - wget
          - build-essential
          - ca-certificates
          - gnupg
        state: present
      when: ansible_os_family == "Debian"

    # Arch Linux specific pre-tasks
    - name: Update pacman cache (Arch Linux)
      community.general.pacman:
        update_cache: true
      when: ansible_os_family == "Archlinux"

    - name: Install essential packages (Arch Linux)
      community.general.pacman:
        name:
          - git
          - curl
          - wget
          - base-devel
          - ca-certificates
          - gnupg
        state: present
      when: ansible_os_family == "Archlinux"

  roles:
    - role: sway
      vars:
        sway_username: "{{ target_user }}"
        # Install method is auto-detected based on OS family in defaults
        # sway_install_method: determined automatically (nix for Debian, native for Arch)
        sway_install_foot_from_source: "{{ ansible_os_family == 'Debian' }}"
        sway_install_fusuma: true
        sway_create_desktop_entry: true
      tags: [sway]

  post_tasks:
    - name: Display completion message (Debian/Ubuntu with Nix)
      ansible.builtin.debug:
        msg: |
          Sway installation complete for {{ target_user }}!

          To start Sway:
          1. Log out of your current session
          2. Select "Sway (Nix)" from the display manager session menu
          3. Or run 'sway-session' from a TTY

          Configuration is located at:
          - Sway config: ~/.config/sway/config
          - Waybar config: ~/.config/waybar/
          - Foot config: ~/.config/foot/foot.ini

          Note: You may need to log out and log back in for group changes to take effect.
      when: ansible_os_family == "Debian"

    - name: Display completion message (Arch Linux)
      ansible.builtin.debug:
        msg: |
          Sway installation complete for {{ target_user }}!

          To start Sway:
          1. Log out of your current session
          2. Select "Sway" from the display manager session menu
          3. Or run 'sway' from a TTY

          Configuration is located at:
          - Sway config: ~/.config/sway/config
          - Waybar config: ~/.config/waybar/
          - Foot config: ~/.config/foot/foot.ini

          Note: You may need to log out and log back in for group changes to take effect.
      when: ansible_os_family == "Archlinux"
